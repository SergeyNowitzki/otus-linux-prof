# otus-linux-proffesional
## TASK 15: Ansible Playbook for Monitoring Configuration (Prometheus-Grafana)

### Vagrant Configuration
The Vagrant file describes installation 2 client VMs and one servers. All VMs run CentOS 7.
1. Modify the variables in the `Vagrantfile` to your desired values.
   
   - Add the path to your SSH public key which will be used for connecting to servers via SSH:
     ```
       ...
       ubuntu_vm.vm.provision "shell", inline: <<-SHELL
       echo "ssh-rsa YOUR PUB KEY" >> /home/vagrant/.ssh/authorized_keys
       SHELL
       ...
     ```

   - In the `Vagrantfile`, choose IP addresses belonging to the chosen subnet:
     ```
     srv_cln.vm.network "private_network", ip: => "192.168.99.xx"
     ```

```
vagrant status

srv_cln1                  running (virtualbox)
srv_cln2                  running (virtualbox)
mon_srv                   running (virtualbox)
```

2. After configuring the `Vagrantfile`, run: `vagrant up`
   - Once VMs is installed, connect to them via SSH:
     ```
     vagrant ssh <hostname>
     ```


### Playbook Structure
Below is the structure of the playbook directory, highlighting the configuration files, roles, and other components:
```
Ansible
├── ansible.cfg                         # Main Ansible configuration file.
├── group_vars
│   └── all.yml                         # Global variables applicable across all hosts.
├── inventories
│   └── hosts.ini                       # Inventory defining groups of hosts and their IPs.
├── main.yml                            # Primary playbook file orchestrating the roles.
├── roles
│   ├── install_grafana                 # Role for installing and configuring Grafana.
│   │   ├── files
│   │   │   ├── CPU_RAM_NET_DISK.json   # Grafana Dashboard
│   │   │   ├── grafana.ini             # Grafana config file
│   │   │   ├── grafana_api_key.txt     # The key will be generated by adding a new service user
│   │   │   └── import_dashboard.py     # Python script for test Grafana API to add a Dashboard
│   │   ├── handlers
│   │   │   └── main.yml                # Necessary handlers for the main tasks
│   │   ├── tasks
│   │   │   └── main.yml                # Main task file for Grafana configuration.
│   │   └── vars
│   │       └── main.yml                # Variables specific to Grafana setup.
│   ├── install_node_exporter           # Role for installing and configuring Node Exporters
│   │   ├── files
│   │   │   ├── node_exporter.service   # Node Exporter config files
│   │   │   └── ntp.conf                # NTP config
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── meta
│   │   │   └── main.yml
│   │   ├── tasks
│   │   │   └── main.yml                # Main task file for Node Exporters configuration. 
│   │   └── vars
│   │       └── main.yml
│   └── install_prometheus
│       ├── files
│       │   ├── ntp.conf
│       │   └── prometheus.service      # Prometheus Service Unit file
│       ├── handlers
│       │   └── main.yml
│       ├── meta
│       │   └── main.yml
│       ├── tasks
│       │   └── main.yml
│       ├── templates
│       │   └── prometheus.yml.j2       # Configuration template for static exporters
│       └── vars
│           └── main.yml
└── templates                            # Storage for template files.
```


### Prometheus Server Configuration (install_prometheus Role)
The `install_prometheus` role installs all necessary components to ensure Prometheus operates correctly.

#### Configuration Steps:
1. **Edit the Configuration Template:** Modify the `prometheus.yml.j2` template to add target clients. These targets are based on the `hosts.ini` file, specifically from the `[node_exporters]` group. This template allows Prometheus to discover the nodes it will monitor.

2. **Run the Ansible Playbook:** After setting up your configuration file and ensuring all roles and dependencies are correctly defined, apply the configurations using the following command:
    ```
    ansible-playbook main.yml --tags tag1
    ```

3. **Verify the Installation:** Once the playbook has been successfully applied, you can access the Prometheus web UI to verify that it's running and monitoring your targets. Open a web browser and navigate to:
    ```
    http://192.168.99.111:9090/graph
    ```
    Replace `192.168.99.111` with the IP address of your Prometheus server if it's different. This page allows you to execute queries and see the metrics collected from your nodes.


### Prometheus Node Exporters Configuration (install_node_exporter Role)
The `install_node_exporter` role is designed to deploy and configure the Prometheus Node Exporter on client servers, enabling them to gather and export system metrics effectively.

#### Deployment Steps:

1. **Role Overview:** This role automatically installs the Prometheus Node Exporter software on the specified target Linux VMs. By doing this, it allows these VMs to collect system metrics, such as CPU, memory usage, disk utilization, and more, which are essential for monitoring and analysis.

2. **Files and Configuration:** The Node Exporter service configuration file, required for its operation, is provided within the `files` directory of this role. It’s important to review and adjust this configuration file if necessary, to meet your specific monitoring requirements.

3. **Execute the Ansible Playbook:** Deploy the Node Exporter to your target machines by running the following Ansible playbook command. Ensure you have listed your target VMs in your Ansible inventory under the appropriate group.

4. **Verify Installation and Configuration:** After the playbook execution, confirm that the Node Exporter has been installed and is running on your client servers. To check if Prometheus is successfully scraping metrics from the Node Exporter instances, access the Prometheus targets page:
    ```
    http://192.168.99.111:9090/targets
    ```
**Note:** The IP address `192.168.99.111` should be replaced with the actual IP address of your Prometheus server if it differs. Also, verify that your network allows access to the Prometheus server on port 9090 to view this page.


### Installation and Configuration Grafana (install_grafana Role)
This role is designed to automate the deployment and configuration of Grafana, enabling you to visualize metrics from Prometheus.
The `CPU_RAM_NET_DISK.json` dashboard template is included to get you started with common metrics.

#### Configuration Overview
The configuration variables for this role are defined in `vars/main.yml`. These variables allow for customization of the Grafana installation, including the admin user, password, data source, and dashboard settings. Here is an example of the variable definitions:
```
---
# vars file for prometheus_grafana
    grafana_admin_user: admin
    grafana_admin_password: newpassword
    prometheus_data_source_name: Prometheus
    grafana_git_repo: https://github.com/enzobes/Grafana-Dashboard.git
    grafana_git_branch: master
    dashboard_json_file: ./roles/install_grafana/files/CPU_RAM_NET_DISK.json
    grafana_ini_path: /etc/grafana/grafana.ini
    backup_path: "/etc/grafana/grafana.ini.backup.{{ ansible_date_time.iso8601_basic_short }}"
    api_key_name: "ansible-generated"
    api_key_role: "Admin"  # Can be Admin, Editor, or Viewer
    api_key_expiration_seconds: 0  # Set to 0 for no expiration
    output_file_path: "./roles/install_grafana/files/grafana_api_key.txt"
```
Creating a `grafana.ini` configuration file that matches common needs involves setting up several key configurations:
- Enable Basic Auth.
- Configure the default admin user and password (important: change the password for production environments).
- Adjust logging settings.
- Fine-tune security settings.

Accessing Grafana
After applying the playbook, access Grafana through the following URL:
```
http://192.168.99.111:3000/
```
Applying Configuration with Ansible
To install and configure Grafana along with the necessary components, run the following command:
```
ansible-playbook main.yml --tags tag3
```
Post-Installation Steps
API Key Generation: A `grafana_api_key.txt` token will be generated for the **service user** after installation. This API key is crucial for making API calls, including adding data sources and dashboards.

Data Source and Dashboard Configuration: The API key enables the addition of Prometheus as a data source and the association of the provided dashboard template with this data source. Ensure the `"datasource": "Prometheus"` value in your dashboard JSON matches the name of your **Prometheus data source**.
