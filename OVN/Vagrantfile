# -*- mode: ruby -*-
# vi: set ft=ruby :

SSH_PUBLIC_KEY = 'ssh-rsa pub key'

Vagrant.configure("2") do |config|
  
  # Use Ubuntu 22.04 box that supports VMware
  config.vm.box = "bento/ubuntu-22.04"
  
  # Default provider settings
  config.vm.provider "vmware_desktop" do |v|
    v.gui = false
    v.vmx["ethernet0.virtualDev"] = "vmxnet3"
  end

  # Common provisioning for all nodes
  config.vm.provision "shell", inline: <<-SHELL
    # Add SSH key
    mkdir -p /home/vagrant/.ssh
    echo '#{SSH_PUBLIC_KEY}' >> /home/vagrant/.ssh/authorized_keys
    chmod 700 /home/vagrant/.ssh
    chmod 600 /home/vagrant/.ssh/authorized_keys
    chown -R vagrant:vagrant /home/vagrant/.ssh
    
    # Update system
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -qq
    
    # Install basic tools
    apt-get install -y \
      net-tools \
      iproute2 \
      tcpdump \
      vim \
      curl \
      wget \
      bridge-utils \
      iputils-ping
    
    # Enable IP forwarding
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    sysctl -p
    
    echo "Common provisioning completed"
  SHELL

  # ========================================
  # OVN Central Node
  # ========================================
  config.vm.define "ovn-central" do |central|
    central.vm.hostname = "ovn-central"
    # Using NAT only - no private network to avoid vmnet issues
    
    central.vm.provider "vmware_desktop" do |v|
      v.vmx["displayName"] = "ovn-central"
      v.memory = "2048"
      v.cpus = 2
    end
    
    central.vm.provision "shell", inline: <<-SHELL
      echo "Installing OVN Central components..."
      
      # Install OVN Central and OVS
      apt-get install -y openvswitch-switch ovn-central
      
      # Start services
      systemctl start openvswitch-switch
      systemctl enable openvswitch-switch
      
      echo "OVN Central installation completed"
      echo "Configure OVN Central manually after all VMs are up"
    SHELL
  end

  # ========================================
  # Compute Node 1
  # ========================================
  config.vm.define "compute-1" do |compute1|
    compute1.vm.hostname = "compute-1"
    
    compute1.vm.provider "vmware_desktop" do |v|
      v.vmx["displayName"] = "compute-1"
      v.memory = "3072"
      v.cpus = 2
      # CRITICAL: Enable nested virtualization for KVM
      v.vmx["vhv.enable"] = "TRUE"
    end
    
    compute1.vm.provision "shell", inline: <<-SHELL
      echo "Installing OVS, OVN host, and KVM packages..."
      
      # Install OVS and OVN
      apt-get install -y openvswitch-switch ovn-host
      
      # Install KVM and libvirt
      apt-get install -y \
        qemu-kvm \
        libvirt-daemon-system \
        libvirt-clients \
        virtinst \
        virt-manager \
        cpu-checker \
        bridge-utils
      
      # Add vagrant to libvirt group
      usermod -aG libvirt vagrant
      
      # Start services
      systemctl start openvswitch-switch
      systemctl enable openvswitch-switch
      systemctl start libvirtd
      systemctl enable libvirtd
      
      # Verify KVM
      echo ""
      echo "=== Verifying KVM Support ==="
      if kvm-ok 2>&1 | grep -q "KVM acceleration can be used"; then
        echo "✅ KVM is working!"
      else
        echo "⚠️  KVM check:"
        kvm-ok
      fi
      
      echo "Compute-1 installation completed"
    SHELL
  end

  # ========================================
  # Compute Node 2
  # ========================================
  config.vm.define "compute-2" do |compute2|
    compute2.vm.hostname = "compute-2"
    
    compute2.vm.provider "vmware_desktop" do |v|
      v.vmx["displayName"] = "compute-2"
      v.memory = "3072"
      v.cpus = 2
      # CRITICAL: Enable nested virtualization for KVM
      v.vmx["vhv.enable"] = "TRUE"
    end
    
    compute2.vm.provision "shell", inline: <<-SHELL
      echo "Installing OVS, OVN host, and KVM packages..."
      
      # Install OVS and OVN
      apt-get install -y openvswitch-switch ovn-host
      
      # Install KVM and libvirt
      apt-get install -y \
        qemu-kvm \
        libvirt-daemon-system \
        libvirt-clients \
        virtinst \
        virt-manager \
        cpu-checker \
        bridge-utils
      
      # Add vagrant to libvirt group
      usermod -aG libvirt vagrant
      
      # Start services
      systemctl start openvswitch-switch
      systemctl enable openvswitch-switch
      systemctl start libvirtd
      systemctl enable libvirtd
      
      # Verify KVM
      echo ""
      echo "=== Verifying KVM Support ==="
      if kvm-ok 2>&1 | grep -q "KVM acceleration can be used"; then
        echo "✅ KVM is working!"
      else
        echo "⚠️  KVM check:"
        kvm-ok
      fi
      
      echo "Compute-2 installation completed"
    SHELL
  end

end