# otus-linux-proffesional
## TASK 23: OpenVPN

### Vagrant File
Vagrant file will install **OpenVPNServer** and **OpenVPNClient** on Ubuntu OS.

### Playbook Structure
```
Ansible/
├── ansible.cfg
├── group_vars
│   └── all.yml
├── host_vars
├── inventories
│   └── hosts.ini
├── provision.yml
└── roles
    ├── basic_cfg
    ├── openvpn_srv
    ├── openvpn_cln
    └── openvpn_ras
```

### Basic Configuration
The `basic_cfg` role is used to install all necessary tools for configuration verification and troubleshooting. It also handles disabling `firewalld` and configuring the **NTP client** on all nodes to keep the date and time updated. At this stage, **OpenVPN** will be installed on all nodes.
```
ansible-playbook provision.yml --tags tag1
```

### OpenVPN Server Configuration
```
ansible-playbook provision.yml --tags tag2
```
This playbook role will generate the **OpenVPN key**, create a service unit, and copy the prepared configuration file `server.conf` to the OpenVPN configuration directory. After all tasks have been successfully applied, the OpenVPN service will be started.

### OpenVPN Client Configuration
```
ansible-playbook provision.yml --tags tag3
```
This role will copy `static.key` to the client, generated by the server, as well as other files that should have been prepared in advance for the OpenVPN service.

#### tun vs tap interfaces
We need to define the interface connection type **tun** or **tap** in the configuration file of the server and client:
```
dev tun/tap
```
In OpenVPN, tun and tap are two different types of virtual network interfaces that serve different purposes and have distinct characteristics. Here are the main differences:

1. **tun** Interface
- Layer: Operates at the IP layer (Layer 3).
- Type: Point-to-point.
- Usage: Typically used for routing (e.g., site-to-site VPNs).
- Packets: Only IP packets are transferred.
- Performance: Generally faster due to less overhead.
- Configuration: Easier to set up for routing purposes.
- MTU: Larger MTU values may require additional configuration to handle fragmentation.
2. **tap** Interface
- Layer: Operates at the Ethernet layer (Layer 2).
- Type: Virtual Ethernet adapter.
- Usage: Typically used for bridging (e.g., connecting two Ethernet segments).
- Packets: Transfers Ethernet frames, including non-IP packets (e.g., ARP, multicast).
- Performance: Generally slower due to additional overhead of handling Ethernet frames.
- Configuration: Requires bridging setup on both sides, which can be more complex.
- MTU: Handles standard Ethernet MTU (1500 bytes) without additional configuration.

##### Impact on Speed
Overhead: **tap** interfaces have more overhead because they handle Ethernet frames, including headers and additional protocol data. This can reduce throughput compared to tun interfaces.
Efficiency: **tun** interfaces are more efficient for pure IP traffic since they don't include Ethernet frame overhead, leading to better performance and potentially higher speeds.
Use Case: The choice between tun and tap should be based on your specific use case:
Use tun for routing scenarios where you only need to transfer IP packets.
Use tap for bridging scenarios where you need to transfer non-IP traffic or require Ethernet broadcast/multicast.

##### Example Use Cases
**Site-to-Site VPN with tun**: Connecting two separate networks over the internet, where only IP traffic needs to be routed.
**Bridging with tap**: Creating a VPN that acts as a virtual Ethernet switch, connecting devices at Layer 2, which might be necessary for certain applications requiring broadcast/multicast traffic.
Configuration Considerations
MTU Adjustments: With tun, you might need to adjust the MTU settings to prevent fragmentation issues.
**Compatibility**: Ensure that the devices and software at both ends of the VPN connection support the chosen interface type.

In summary, tun is typically faster and more efficient for routing IP traffic, while tap provides full Ethernet bridging capabilities at the cost of additional overhead. Choose the interface type that best matches your network requirements and performance considerations.

We can c compare using different type of interfaces with the `iperf3` utility.
On the server side in the **tap** mode:
<img width="852" alt="image" src="https://github.com/SergeyNowitzki/otus-linux-prof/assets/39993377/1998663b-34d7-4c70-81c6-0a4b88e36631">

```
iperf3 -s &
```
On the client side:
```
iperf3 -c 10.10.10.1 -t 40 -i 5
```
<img width="648" alt="image" src="https://github.com/SergeyNowitzki/otus-linux-prof/assets/39993377/1a1dadbc-4e94-4de3-965b-80ecaa3ef884">
<br>
Using the same command in the **tun** mode:
<img width="637" alt="image" src="https://github.com/SergeyNowitzki/otus-linux-prof/assets/39993377/68a4cdea-4f4a-474d-b48f-7da0e10eba30">

Although after testing the speed between the client and server with different types of interfaces, we can see a slight difference which proves the theory.

### RAS based on OpenVPN
"Remote Access Server" This involves a setup where users can securely connect to a private network over the internet using OpenVPN.
The RAS in OpenVPN provides secure, encrypted connections for users working remotely, allowing them access to the network's resources as if they were physically present in the network's location.
```
ansible-playbook provision.yml --tags tag4
```

The Ansible role is divided into two blocks which configure the server and client respectively.

The **server block** initializes the PKI and generates all necessary files for the client and server. The `server.conf` file on the server side should be changed to include all necessary files generated during the PKI initialization.

The generated files on the server must be copied to the client `/etc/openvpn/client`:
```
/etc/openvpn/pki/ca.crt 
/etc/openvpn/pki/issued/client.crt 
/etc/openvpn/pki/private/client.key
```
After copying the files, the connection can be checked with `openvpn --config /etc/openvpn/client/client.conf`:
```
ping -c 4 10.10.10.1
```
<img width="903" alt="image" src="https://github.com/SergeyNowitzki/otus-linux-prof/assets/39993377/7c6d962c-8ea0-48ae-bb9c-12a67be27c92">
<img width="982" alt="image" src="https://github.com/SergeyNowitzki/otus-linux-prof/assets/39993377/e8d2956d-a15a-459b-a252-00547b88b4b5">
